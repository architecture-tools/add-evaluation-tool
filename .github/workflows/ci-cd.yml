name: CI/CD

on:
  pull_request:
  release:
    types:
      - published

permissions:
  contents: read

env:
  PYTHON_VERSION: "3.11"
  POETRY_VERSION: "1.8.3"

jobs:
  lint:
    name: Static analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry virtualenv
        uses: actions/cache@v4
        with:
          path: backend/.venv
          key: ${{ runner.os }}-poetry-${{ env.PYTHON_VERSION }}-${{ hashFiles('backend/poetry.lock') }}

      - name: Install backend dependencies
        working-directory: backend
        run: poetry install --no-ansi --no-interaction

      - name: Check Python formatting
        working-directory: backend
        run: poetry run ruff format --check app main.py

      - name: Run Ruff + Mypy
        working-directory: backend
        run: make lint

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install frontend dependencies
        working-directory: frontend
        run: flutter pub get

      - name: Check Dart formatting
        working-directory: frontend
        run: dart format --output=none --set-exit-if-changed .

      - name: Run Dart analyzer
        working-directory: frontend
        run: |
          dart analyze 2>&1 | tee /tmp/dart_analyze.log || true
          if grep -qE "^(error|Error)" /tmp/dart_analyze.log; then
            echo "Dart analyzer found errors!"
            exit 1
          fi
          echo "Dart analyzer passed (only info/warnings, no errors)"

      - name: Lint Markdown
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          globs: |
            README.md
            docs/**/*.md
            !docs/.github-pages/**/*.md

      - name: Check documentation links
        uses: lycheeverse/lychee-action@v2.1.0
        with:
          args: --no-progress --accept 200,204,301,302,307,308,429 --timeout 30 --retry-wait-time 2 --exclude-all-private --exclude '^file://' README.md docs/**/*.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: false

  test-backend:
    name: Backend tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry virtualenv
        uses: actions/cache@v4
        with:
          path: backend/.venv
          key: ${{ runner.os }}-poetry-${{ env.PYTHON_VERSION }}-${{ hashFiles('backend/poetry.lock') }}

      - name: Install backend dependencies
        run: poetry install --no-ansi --no-interaction

      - name: Run backend tests
        run: make test

      - name: Enforce module coverage thresholds
        run: poetry run python scripts/check_module_coverage.py

      - name: Publish coverage summary
        run: |
          TOTAL_COVERAGE=$(python - <<'PY'
          import json
          from pathlib import Path
          
          data = json.loads(Path("coverage.json").read_text())
          totals = data.get("totals", {})
          percent = totals.get("percent_covered", 0.0)
          covered = totals.get("covered_lines", 0)
          statements = totals.get("num_statements", 0)
          print(f"{percent:.2f}|{covered}|{statements}")
          PY
          )
          IFS='|' read -r PERCENT COVERED TOTAL <<<"$TOTAL_COVERAGE"
          {
            echo "### Backend coverage"
            echo ""
            echo "- Total lines covered: ${COVERED}/${TOTAL}"
            echo "- Line coverage: ${PERCENT}% (minimum 80% on guarded modules)"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-${{ github.run_number }}
          path: |
            backend/coverage.xml
            backend/coverage.json
          if-no-files-found: error
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: backend/coverage.xml
          flags: backend
          name: backend-coverage

  test-frontend:
    name: Frontend tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            frontend/.dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('frontend/pubspec.lock') }}

      - name: Install frontend dependencies
        run: flutter pub get

      - name: Set up Python for API generation
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install openapi-generator
        run: |
          npm install -g @openapitools/openapi-generator-cli

      - name: Generate API client
        run: make generate-api

      - name: Run Flutter tests
        run: flutter test --coverage

      - name: Publish coverage summary
        run: |
          if [ -f coverage/lcov.info ]; then
            # Parse lcov.info using Python, excluding generated code
            COVERAGE_DATA=$(python3 - <<'PY'
          import re
          from pathlib import Path
          
          lcov_file = Path("coverage/lcov.info")
          if not lcov_file.exists():
              print("0.0|0|0|0|0")
              exit(0)
          
          total_lines = 0
          hit_lines = 0
          total_excluded = 0
          hit_excluded = 0
          
          # Files/directories to exclude from coverage (generated code)
          exclude_patterns = [
              'lib/network/src/',  # Generated API client
              'lib/main.dart',     # Entry point (minimal logic)
          ]
          
          current_file = None
          skip_file = False
          
          with open(lcov_file, 'r') as f:
              for line in f:
                  # Match SF: (source file)
                  sf_match = re.match(r'^SF:(.+)', line)
                  if sf_match:
                      current_file = sf_match.group(1)
                      skip_file = any(pattern in current_file for pattern in exclude_patterns)
                      continue
                  
                  # Only count if not excluded
                  if not skip_file:
                      lf_match = re.match(r'^LF:(\d+)', line)
                      lh_match = re.match(r'^LH:(\d+)', line)
                      
                      if lf_match:
                          total_lines += int(lf_match.group(1))
                      elif lh_match:
                          hit_lines += int(lh_match.group(1))
                  else:
                      # Track excluded for reporting
                      lf_match = re.match(r'^LF:(\d+)', line)
                      lh_match = re.match(r'^LH:(\d+)', line)
                      if lf_match:
                          total_excluded += int(lf_match.group(1))
                      elif lh_match:
                          hit_excluded += int(lh_match.group(1))
          
          if total_lines > 0:
              percentage = (hit_lines / total_lines) * 100
          else:
              percentage = 0.0
          
          print(f"{percentage:.1f}|{hit_lines}|{total_lines}|{hit_excluded}|{total_excluded}")
          PY
            )
            IFS='|' read -r PERCENTAGE HIT_LINES TOTAL_LINES HIT_EXCLUDED TOTAL_EXCLUDED <<<"$COVERAGE_DATA"
            
            {
              echo "### Frontend coverage"
              echo ""
              echo "- Total lines covered: ${HIT_LINES}/${TOTAL_LINES} (excluding generated code)"
              echo "- Line coverage: ${PERCENTAGE}%"
              if [ "$TOTAL_EXCLUDED" -gt 0 ]; then
                echo "- Excluded: ${TOTAL_EXCLUDED} lines (generated API client)"
              fi
            } >> "$GITHUB_STEP_SUMMARY"
          else
            {
              echo "### Frontend coverage"
              echo ""
              echo "- Tests executed successfully"
              echo "⚠️ Warning: Coverage file not found"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-${{ github.run_number }}
          path: frontend/coverage/lcov.info
          if-no-files-found: ignore

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage

  test-integration:
    name: Integration tests (QASTs)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start services with docker compose
        run: |
          docker compose up -d --build
          docker compose ps

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for backend to be ready..."
          timeout 120 bash -c 'until curl -f http://localhost:8000/api/v1/health; do sleep 2; done' || exit 1
          echo "Backend is ready!"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry virtualenv
        uses: actions/cache@v4
        with:
          path: backend/.venv
          key: ${{ runner.os }}-poetry-${{ env.PYTHON_VERSION }}-${{ hashFiles('backend/poetry.lock') }}

      - name: Install backend dependencies
        run: poetry install --no-ansi --no-interaction

      - name: Run QAST202-1 (PlantUML Processing Performance)
        id: qast202
        env:
          API_URL: http://localhost:8000
        run: poetry run python scripts/test_qast202_1.py
        continue-on-error: true

      - name: Run QAST302-1 (Component Extraction Accuracy)
        id: qast302
        env:
          API_URL: http://localhost:8000
        run: poetry run python scripts/test_qast302_1.py
        continue-on-error: true

      - name: Publish QAST results summary
        run: |
          {
            echo "### Quality Attribute Scenario Tests (QASTs)"
            echo ""
            echo "#### QAST202-1: PlantUML Processing Performance"
            if [ "${{ steps.qast202.outcome }}" == "success" ]; then
              echo "✅ **PASSED** - 95%+ of files processed within 3 seconds"
            else
              echo "❌ **FAILED** - Performance requirements not met"
            fi
            echo ""
            echo "**Reference:** [QAST202-1](../docs/requirements/quality-requirements.md#qast202-1)"
            echo ""
            echo "#### QAST302-1: Component Extraction Accuracy"
            if [ "${{ steps.qast302.outcome }}" == "success" ]; then
              echo "✅ **PASSED** - 95%+ extraction accuracy achieved"
            else
              echo "❌ **FAILED** - Accuracy requirements not met"
            fi
            echo ""
            echo "**Reference:** [QAST302-1](../docs/requirements/quality-requirements.md#qast302-1)"
            echo ""
            echo "**Implementation:**"
            echo "- [QAST202-1 script](../backend/scripts/test_qast202_1.py)"
            echo "- [QAST302-1 script](../backend/scripts/test_qast302_1.py)"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Cleanup docker compose
        if: always()
        run: |
          docker compose down -v

      - name: Fail if any QAST failed
        if: steps.qast202.outcome != 'success' || steps.qast302.outcome != 'success'
        run: |
          echo "One or more QASTs failed. Check the logs above for details."
          exit 1
